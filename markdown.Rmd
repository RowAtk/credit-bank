---
title: 'Scrum Cycle 05: Working in Python or R'
author: "Code Crusaders"
date: "4/28/2020"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
  ioslides_presentation: default
---


```{r setup, include=FALSE, warning=FALSE, message=FALSE }
knitr::opts_chunk$set(
  #include = FALSE,
  echo = FALSE,
  eval = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.height = 3,
  fig.width = 4,
  tidy = FALSE,
  tidy.opts=list(blank=FALSE,size = 'tiny'))
library(knitr)
library(dplyr)
library(papeR)
library(kableExtra)
library(magick)
bank.data <- read.csv(file = "cohort2020-set-a.csv", stringsAsFactors = TRUE, header = TRUE, sep = ',', na.strings = c("", "NA"))
```

```{r core-functions}
view = function(data, scroll=FALSE) {
  if(scroll == TRUE) {
    kable(data) %>%
      kable_styling(bootstrap_options = "striped", font_size = 12, full_width = FALSE) %>%
        scroll_box(width = "auto")
  } else {
    kable(data) %>%
      kable_styling(bootstrap_options = "striped", font_size = 12, full_width = FALSE)
  }
}
```

## Our Data
```{r}
df = head(bank.data)
kable(df) %>%
  kable_styling(bootstrap_options = "striped", font_size = 12, full_width = FALSE)
```

## Summary
```{r}
summ = summary(bank.data)
view(summ)
```

## Preparing Data

### RefNum
```{r}
#ref.num = data.frame(values=df$RefNum, summary=summ)
view(t(df$RefNum))
```
```{r echo=TRUE}
bank.data$RefNum = NULL # no use for reference number
```

### Age
```{r}
view(t(df$age))
```
```{r echo=TRUE}
boxplot(bank.data$age)
```

### Job
```{r echo=TRUE}
nrow(bank.data[is.na(bank.data$job),])
bank.data = bank.data[!is.na(bank.data$job),]
```

### Marital
No outliers or missing values

### Education
#### Before
```{r}
view(t(summary(bank.data$education)))
```
```{r echo=TRUE}
bank.data = bank.data[!is.na(bank.data$education),]
bank.data$education <- as.integer(as.factor(bank.data$education))
levels(bank.data$education) # no longer factor
```
#### After
```{r}
view(t(summary(bank.data$education)))
```

### Contact
```{r echo=TRUE}
nrow(bank.data[is.na(bank.data$contact),]) / nrow(bank.data) * 100
bank.data$contact = NULL # no use for contact feature which was mostly empty 
```

### Housing
#### Before
```{r}
view(t(summary(bank.data$housing)))
```
```{r echo=TRUE}
bank.data = bank.data[!is.na(bank.data$housing),] # remove rows with N/A in housing
lst <- bank.data$housing
lvl <- levels(lst)
new_housing = setNames(
  data.frame(do.call(rbind,lapply(lst, function(x) as.integer(lvl %in% x)) )), 
  c("housing_n", "housing_y"))
head(data.frame(old=bank.data$housing, new=new_housing))
bank.data = cbind(bank.data, new_housing)
```

#### After
```{r}
view(head(bank.data[,0:-4]))
```

### Loan
#### Before
```{r}
view(t(summary(bank.data$loan)))
```
```{r echo=TRUE}
lst <- bank.data$loan
lvl <- levels(lst)
new_loan = setNames(
  data.frame(do.call(rbind,lapply(lst, function(x) as.integer(lvl %in% x)) )), 
  c("loan_n", "loan_y"))
head(data.frame(old=bank.data$loan, new=new_loan))
bank.data = cbind(bank.data, new_loan)
```

#### After
```{r}
view(head(bank.data[,0:-4]))
```

### Month
#### Before
```{r}
view(t(head(bank.data$month)))
```
```{r echo=TRUE}
bank.data$month <- match(as.factor(bank.data$month), tolower(month.name))
```

#### After
```{r}
view(t(head(bank.data$month)))
```

### Day
#### Before
```{r}
view(t(summary(bank.data$day)))
```
```{r echo=TRUE}
# outliers - dates that do not exist / are not possible Eg Feb 30, 2019
library(lubridate)

# view all noisy dates
view(bank.data[days_in_month(bank.data$month)  < bank.data$day, c("day", "month")]) 
bank.data$day[bank.data$day > 28 & bank.data$month == 2] = 28 # fix noisy dates
```

### Duration
```{r}
# no missing values
hist(bank.data$duration, main = "Duration of contact with clients", xlab = "Duration in seconds")
boxplot(bank.data$duration)
```

### Deposit
```{r}
hist(bank.data$deposit)
boxplot(bank.data$deposit)
```
```{r echo=TRUE}
# contains outliers and missing values. 
nrow(bank.data[is.na(bank.data$deposit),])
# Outliers were left alone missing values replaced with median
bank.data$deposit[is.na(bank.data$deposit)] = median(bank.data$deposit, na.rm = TRUE)
```

### Balance
```{r}
boxplot(bank.data$balance)
```

### End of initial data preparation
```{r echo=TRUE}
nrow(bank.data[!complete.cases(bank.data),])
```

## TASK 02
Convert from seconds to minutes
```{r}
view(t(head(bank.data$duration)))
```
```{r echo=TRUE}                                                                                                                          
minutes = function (seconds) {
  period = seconds_to_period(bank.data$duration)
  return(minute(period) + 0.01 * second(period))
}

bank.data$duration = minutes(bank.data$duration)
```

### RESULT
```{r}
view(t(head(bank.data$duration)))
```

## TASK 03
Discretization of Ages

### Before
Summary
```{r}
view(t(summary(bank.data$age)))
```
Sample
```{r}
view(t(head(bank.data$age)))
```
```{r echo=TRUE}
bins <- 4
abs.max <- max(bank.data$age)
abs.min <- min(bank.data$age)
new.max <- abs.max + bins 
width <- (new.max - abs.min) / bins

age.temp = cut(
  bank.data$age, 
  breaks = seq(abs.min, new.max, width), 
  labels = c("Young Adult","Adults", "Mid-life", "Elderly"), 
  right = FALSE)
bank.data$age <- age.temp
```

### After
```{r}
view(t(head(bank.data$age)))
```

## TASK 04
Feature Normalization - Deposit

### Deposit
```{r}
view(t(summary(bank.data$deposit)))
```
```{r echo=TRUE}
# deposit normalization
deposit.min <- min(bank.data$deposit)
deposit.max <- max(bank.data$deposit)
deposit.norm <- ((bank.data[, "deposit"] - deposit.min) / 
                   (deposit.max - deposit.min)) * ((100 - 1) + 1)
deposit.norm <- round(deposit.norm, digits = 2)
summary(deposit.norm)
bank.data$deposit <- deposit.norm
```

## TASK 05
Find the number of days since the client made a deposit

```{r echo=TRUE}
view(head(bank.data[,c("day", "month")]))
```
```{r echo=TRUE}
# make a date string
#string = paste(5, 3, year(today), sep = "-")

# make a date
#something <- mdy(paste(5, 3, year(today), sep = "-"))

bank.data$deposit_date <- mdy(paste(bank.data$month, bank.data$day, "2019", sep = "-")) 

bank.data$last_deposit <- as.numeric(today() - bank.data$deposit_date)
```

### RESULT
```{r}
view(head(bank.data[,0:-6]))
```

## TASK 06
Comparison over two periods - using Time-Series graph

```{r}
library(ggplot2)
theme_set(theme_light())
```
```{r echo=TRUE}
data <- bank.data %>% select(deposit_date, deposit)
period_one <- data %>% filter(data$deposit_date >= as.Date("2019-01-01") & data$deposit_date <= as.Date("2019-03-31"))
period_two <- data %>% filter(data$deposit_date >= as.Date("2019-04-01") & data$deposit_date >= as.Date("2019-06-30"))

ggplot(period_one, aes(x=deposit_date)) +
  geom_line(aes(y=deposit)) + labs(y="Quater 1 Deposits", x="Deposit Date")

ggplot(period_two, aes(x=deposit_date)) +
  geom_line(aes(y=deposit)) + labs(y="Quater 2 Deposits", x="Deposit Date")
```

## TASK 07
### A
Which categories of jobs have the top two highest average deposits

```{r echo=TRUE}
Job <- levels(bank.data$job)
Average_deposit <- rep(0, length(Job))
job_deposits <- data.frame(Job, Average_deposit)

for(x in 1:(length(Job))){
  #sum the deposits for each job type
  temp <- sum(bank.data[bank.data$job == Job[x], 10]) / 
    nrow(bank.data[bank.data$job == Job[x],]) 
  job_deposits$Average_deposit[x] <- temp
}

#sort in decending order by average deposit
job_deposits = job_deposits[with(job_deposits, order(-job_deposits$Average_deposit)),] 

job_deposits$Average_deposit = round(job_deposits$Average_deposit, digits = 2)
```
```{r}
view(job_deposits[0:2,])
```

### B
dominant educational level for each job type
```{r echo=TRUE}
Educational_level <- rep(0, length(Job))
dominant_ed <- data.frame(Job, Educational_level)

modefunc <- function(v) {
  a <- unique(v)
  a[which.max(tabulate(match(v, a)))]
}

for(x in 1:(length(Job))){
  temp <- bank.data[bank.data$job == Job[x], 4]
  dominant_ed$Educational_level[x] <- modefunc(temp)
}
view(dominant_ed[with(dominant_ed, order(dominant_ed$Job)),])
```

### C
```{r echo=TRUE}
no_loan <- bank.data[(bank.data$housing_n == 1) & (bank.data$loan_n == 1),]
nrow(no_loan) / nrow(bank.data) * 100
```

### D
```{r echo=TRUE}
age_groups = levels(bank.data$age)
balance <- rep(0, length(age_groups))
age_balance <- data.frame(age_groups, balance)

for(x in 1:(length(age_groups))){
  temp <- sum(bank.data[bank.data$age == age_groups[x], 11]) /
    nrow(bank.data[bank.data$age == age_groups[x],]) #sum the deposits for each job type
  age_balance$balance[x] <- round(temp, digits = 2)
}
```
```{r}
view(age_balance)
view(age_balance[age_balance$balance == max(age_balance$balance), ])
```

### E
```{r echo=TRUE}
dep_bal = bank.data[, c("deposit", "balance")]
dep_bal.cor = cor(dep_bal$balance, dep_bal$deposit)

library(corrplot)
corrplot(
  cor(dep_bal, method = "pearson"), 
  method = "color", 
  order = "AOE", 
  tl.col = "black", 
  tl.cex = 1, 
  addCoef.col = "white")
```

### F 
```{r echo=TRUE}
neg <- bank.data %>% filter(bank.data$balance < 0)
view(head(neg), scroll = TRUE)

neg <- neg %>% filter(neg$marital == "married")
view(head(neg), scroll = TRUE)

percent <- nrow(neg)/nrow(bank.data) *100
view(t(percent))
```

### G
```{r echo=TRUE}
credit_risk <- bank.data %>% filter(
  bank.data$housing_y == 1 & 
  bank.data$loan_n == 1 & 
  bank.data$balance >= 500000)
nrow(credit_risk)
```
```{r}
view(head(credit_risk[,0:-4]))
```